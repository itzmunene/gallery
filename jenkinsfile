pipeline {
    agent any

    environment {
        NODE_ENV = "production"
        MONGO_URI = credentials('mongo-uri-secret')  // Add in Jenkins → Credentials → Secret Text
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/itzmunene/gallery'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'npm install'
            }
        }

        stage('Test DB Connection') {
            steps {
                sh 'node -e "require(\'mongoose\').connect(process.env.MONGO_URI).then(()=>console.log(\'✅ Mongo OK\')).catch(err=>console.error(\'❌\',err))"'
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                npm install -g pm2
                pm2 stop darkroom || true
                pm2 start server.js --name darkroom
                pm2 save
                '''
            }
        }
    }
}
